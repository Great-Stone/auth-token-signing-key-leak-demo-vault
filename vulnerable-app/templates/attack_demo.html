<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µê²© ë°ëª¨ - ìœ ì¶œëœ ì„œëª… í‚¤ë¡œ íƒ€ì¸ ì •ë³´ ì ‘ê·¼</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #d32f2f;
        }
        h2 {
            color: #1976d2;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 10px;
        }
        .step {
            margin: 30px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #1976d2;
        }
        .step h3 {
            margin-top: 0;
            color: #1976d2;
        }
        .btn {
            padding: 10px 20px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #1565c0;
        }
        .btn-danger {
            background-color: #d32f2f;
        }
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        .result {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
        }
        .error {
            background-color: #ffebee;
            border: 1px solid #d32f2f;
        }
        .info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
        }
        select, input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        .token-display {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            margin: 10px 0;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .user-card {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        .user-card.selected {
            border-color: #1976d2;
            background-color: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”“ ê³µê²© ë°ëª¨ - ìœ ì¶œëœ ì„œëª… í‚¤ë¡œ íƒ€ì¸ ì •ë³´ ì ‘ê·¼</h1>
        
        <div class="warning">
            <strong>âš ï¸ ê²½ê³ :</strong> ì´ ë°ëª¨ëŠ” ë³´ì•ˆ ì·¨ì•½ì ì„ ì¬í˜„í•˜ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.
            ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
        </div>
        
        <p><a href="/">â† í™ˆìœ¼ë¡œ</a></p>
    </div>

    <div class="container">
        <div class="step">
            <h3>1ë‹¨ê³„: ì‚¬ìš©ì ëª©ë¡ í™•ì¸</h3>
            <p>ê³µê²©í•  íƒ€ê²Ÿ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <button class="btn" onclick="loadUsers()">ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <div id="users-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <div class="step">
            <h3>2ë‹¨ê³„: ìœ ì¶œëœ í‚¤ë¡œ ë¹„ì¸ì¦ í† í° ìƒì„±</h3>
            <p>ìœ ì¶œëœ ì„œëª… í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ íƒí•œ ì‚¬ìš©ìì˜ í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
            <label>íƒ€ê²Ÿ ì‚¬ìš©ì ID: </label>
            <input type="number" id="target-user-id" value="2" min="1" max="10">
            <button class="btn btn-danger" onclick="generateFakeToken()">ë¹„ì¸ì¦ í† í° ìƒì„±</button>
            <div id="token-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <div class="step">
            <h3>3ë‹¨ê³„: ìƒì„±í•œ í† í°ìœ¼ë¡œ íƒ€ì¸ ì •ë³´ ì ‘ê·¼</h3>
            <p>ìƒì„±í•œ í† í°ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì •ë³´ì— ì ‘ê·¼í•©ë‹ˆë‹¤.</p>
            <label>ì ‘ê·¼í•  ì‚¬ìš©ì ID: </label>
            <input type="number" id="access-user-id" value="2" min="1" max="10">
            <button class="btn btn-danger" onclick="testToken()">í† í°ìœ¼ë¡œ ì •ë³´ ì ‘ê·¼</button>
            <div id="test-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <div class="container">
        <div class="step">
            <h3>4ë‹¨ê³„: ì§ì ‘ í† í° ì…ë ¥í•˜ì—¬ í…ŒìŠ¤íŠ¸</h3>
            <p>ìƒì„±í•œ í† í°ì„ ì§ì ‘ ì…ë ¥í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í† í°ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ í† í°ì˜ user_idê°€ ì¶”ì¶œë˜ì–´ í•´ë‹¹ ì‚¬ìš©ì ì •ë³´ì— ì ‘ê·¼í•©ë‹ˆë‹¤.</p>
            <div class="info" style="padding: 10px; margin: 10px 0; border-radius: 4px;">
                <strong>ğŸ’¡ í† í° ìƒì„± ë°©ë²•:</strong><br>
                <strong>ë°©ë²• 1 - exploit.py:</strong> <code>hack-demo ë””ë ‰í† ë¦¬ì—ì„œ python exploit.py</code> ì‹¤í–‰ í›„ ìƒì„±ëœ í† í° ë³µì‚¬<br>
                <strong>ë°©ë²• 2 - OpenSSL:</strong> <code>hack-demo ë””ë ‰í† ë¦¬ì—ì„œ ./generate_token.sh 2 bob bob@example.com</code> ì‹¤í–‰ í›„ ìƒì„±ëœ í† í° ë³µì‚¬
            </div>
            <label>í† í°: </label><br>
            <textarea id="manual-token" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 11px;" placeholder="ì—¬ê¸°ì— í† í°ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (exploit.py ë˜ëŠ” generate_token.shì—ì„œ ìƒì„±í•œ í† í°)" oninput="extractUserIdFromToken()"></textarea><br>
            <div id="token-user-id-info" style="margin: 10px 0; padding: 8px; background-color: #e3f2fd; border-radius: 4px; font-size: 14px;"></div>
            <button class="btn" onclick="testManualToken()">í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼</button>
            <div id="manual-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let generatedToken = null;
        let generatedUserId = null;

        async function loadUsers() {
            const resultDiv = document.getElementById('users-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

            try {
                const response = await fetch('/users');
                if (response.ok) {
                    const users = await response.json();
                    let html = '<div class="user-list">';
                    users.forEach(user => {
                        html += `<div class="user-card" onclick="selectUser(${user.id})">
                            <strong>ID: ${user.id}</strong><br>
                            ì‚¬ìš©ìëª…: ${user.username}<br>
                            ì´ë©”ì¼: ${user.email}
                        </div>`;
                    });
                    html += '</div>';
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        function selectUser(userId) {
            document.getElementById('target-user-id').value = userId;
            document.getElementById('access-user-id').value = userId;
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        async function generateFakeToken() {
            const userId = parseInt(document.getElementById('target-user-id').value);
            const resultDiv = document.getElementById('token-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'í† í° ìƒì„± ì¤‘...';

            try {
                const response = await fetch('/api/generate-fake-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                if (response.ok) {
                    const data = await response.json();
                    generatedToken = data.token;
                    generatedUserId = userId;
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
âœ… ê°€ì§œ í† í° ìƒì„± ì„±ê³µ!

<strong>ìƒì„±ëœ í† í°:</strong>
<div class="token-display">${data.token}</div>

<strong>í† í° Payload:</strong>
<pre>${JSON.stringify(data.payload, null, 2)}</pre>

<strong>íƒ€ê²Ÿ ì‚¬ìš©ì:</strong>
- ID: ${data.user.id}
- ì‚¬ìš©ìëª…: ${data.user.username}
- ì´ë©”ì¼: ${data.user.email}

âš ï¸ ì´ í† í°ì€ ìœ ì¶œëœ ì„œëª… í‚¤ë¡œ ìƒì„±ë˜ì—ˆì§€ë§Œ, ì •ìƒì ìœ¼ë¡œ ê²€ì¦ì„ í†µê³¼í•©ë‹ˆë‹¤!
                    `;
                    
                    // ìˆ˜ë™ ì…ë ¥ í•„ë“œì—ë„ í† í° ì„¤ì •
                    document.getElementById('manual-token').value = data.token;
                    // í† í°ì˜ user_id ìë™ ì¶”ì¶œ
                    extractUserIdFromToken();
                } else {
                    const error = await response.json();
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.error || response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        async function testToken() {
            if (!generatedToken) {
                alert('ë¨¼ì € ë¹„ì¸ì¦ í† í°ì„ ìƒì„±í•˜ì„¸ìš” (2ë‹¨ê³„)');
                return;
            }

            const userId = parseInt(document.getElementById('access-user-id').value);
            const resultDiv = document.getElementById('test-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'í† í° í…ŒìŠ¤íŠ¸ ì¤‘...';

            try {
                const response = await fetch('/api/test-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: generatedToken,
                        user_id: userId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
âœ… ${data.message}

<strong>ì ‘ê·¼í•œ ì‚¬ìš©ì ì •ë³´:</strong>
<pre>${JSON.stringify(data.user, null, 2)}</pre>

<strong>í† í° ì •ë³´:</strong>
<pre>${JSON.stringify(data.token_info, null, 2)}</pre>

âš ï¸ ìœ ì¶œëœ í‚¤ë¡œ ìƒì„±í•œ í† í°ìœ¼ë¡œ ë‹¤ë¥¸ ì‚¬ìš©ì ì •ë³´ì— ì ‘ê·¼í–ˆìŠµë‹ˆë‹¤!
í† í°ì˜ user_id(${data.token_info.user_id})ì™€ ìš”ì²­í•œ user_id(${userId})ê°€ ë‹¤ë¥´ì§€ë§Œ ì ‘ê·¼ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
                    `;
                } else {
                    const error = await response.json();
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.error || response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        function extractUserIdFromToken() {
            const token = document.getElementById('manual-token').value.trim();
            const infoDiv = document.getElementById('token-user-id-info');
            
            if (!token) {
                infoDiv.innerHTML = '';
                return;
            }

            try {
                // JWT í† í° ë””ì½”ë”© (ì„œëª… ê²€ì¦ ì—†ì´)
                const parts = token.split('.');
                if (parts.length !== 3) {
                    infoDiv.innerHTML = '<span style="color: #d32f2f;">âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ í† í° í˜•ì‹</span>';
                    return;
                }

                const payload = JSON.parse(atob(parts[1]));
                const tokenUserId = payload.user_id;
                const username = payload.username || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const email = payload.email || 'ì•Œ ìˆ˜ ì—†ìŒ';

                if (tokenUserId) {
                    infoDiv.innerHTML = `
                        <strong>í† í° ì •ë³´:</strong><br>
                        - User ID: <strong>${tokenUserId}</strong><br>
                        - Username: ${username}<br>
                        - Email: ${email}<br>
                        <span style="color: #4caf50;">âœ“ í† í°ì˜ user_id(${tokenUserId})ë¡œ ìë™ ì ‘ê·¼í•©ë‹ˆë‹¤</span>
                    `;
                } else {
                    infoDiv.innerHTML = '<span style="color: #ff9800;">âš ï¸ í† í°ì— user_idê°€ ì—†ìŠµë‹ˆë‹¤</span>';
                }
            } catch (error) {
                infoDiv.innerHTML = '<span style="color: #d32f2f;">âš ï¸ í† í° ë””ì½”ë”© ì‹¤íŒ¨: ' + error.message + '</span>';
            }
        }

        async function testManualToken() {
            const token = document.getElementById('manual-token').value.trim();

            if (!token) {
                alert('í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            // í† í°ì—ì„œ user_id ì¶”ì¶œ
            let userId = null;
            try {
                const parts = token.split('.');
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1]));
                    if (payload.user_id) {
                        userId = payload.user_id;
                    } else {
                        alert('í† í°ì— user_idê°€ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }
                } else {
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ í† í° í˜•ì‹ì…ë‹ˆë‹¤');
                    return;
                }
            } catch (e) {
                alert('í† í° ë””ì½”ë”© ì‹¤íŒ¨: ' + e.message);
                return;
            }

            const resultDiv = document.getElementById('manual-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì ‘ê·¼ ì¤‘...';

            try {
                const response = await fetch('/api/test-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        user_id: userId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
âœ… ${data.message}

<strong>ì ‘ê·¼í•œ ì‚¬ìš©ì ì •ë³´:</strong>
<pre>${JSON.stringify(data.user, null, 2)}</pre>

<strong>í† í° ì •ë³´:</strong>
<pre>${JSON.stringify(data.token_info, null, 2)}</pre>

<strong>ì·¨ì•½ì  í™•ì¸:</strong>
- ìœ ì¶œëœ í‚¤ë¡œ ìƒì„±í•œ í† í°ì´ ì •ìƒì ìœ¼ë¡œ ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤
- í† í°ì˜ user_id(${data.token_info.user_id})ë¡œ ì‚¬ìš©ì ì •ë³´ì— ì ‘ê·¼í–ˆìŠµë‹ˆë‹¤
- âš ï¸ ì´ í† í°ì€ ìœ ì¶œëœ ê°œì¸í‚¤ë¡œ ì„œëª…ë˜ì—ˆì§€ë§Œ, ì •ìƒì ìœ¼ë¡œ ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤!
                    `;
                } else {
                    const error = await response.json();
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.error || response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }
    </script>
</body>
</html>

